---
title: "Regression Models MA data analysis"
output: 
  rmdformats::readthedown:
  # pdf_document:
  # html_document:
  #   toc: true
  #   theme: united
  # code_folding: hide
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
knitr::opts_chunk$set(fig.show="hold", out.width="50%") 
```


```{r data import, warning=FALSE, message=FALSE, echo=FALSE}
## Data Preprocess
library(readr)
library(dplyr)
library(tidyr)
library(purrr)
library(tidyverse)
library(broom)
library(moderndive)
library(ggplot2)
# data import
rm(df)
dataPass = "/Users/am/Library/CloudStorage/OneDrive-UNBC/00MAthesis/ma24r/ma24data"
df <- read_csv(dataPass)
rm(dataPass)
```

```{r data process, warning=FALSE, message=FALSE}
df <- df %>% mutate(
  food_waste_p_kg = food_waste_kg/customers,
  solid_waste_p_kg = solid_waste_kg/customers,
  liquid_waste_p_kg = liquid_waste_kg/customers
) %>% 
  replace_na(list(food_waste_p_kg = 0,
                  solid_waste_p_kg = 0,
                  liquid_waste_p_kg = 0))
```


## Additive Multiple Linear Model
## solid and liquid food waste
```{r simple multiple regression}
library(modeldata)
library(purrr)
library(tidyr)
## Multi-output linear regression -----
#### Target outcomes:
# 1. food_loss_kg
# 2. food_waste_kg
# 3. solid_waste_kg
# 4. liquid_waste_kg
## predictors: temp_c, humi_p, prcp_mm, 
#              tueE, wedE, thuE, friE, satE,
#              container, liquors, sales, halfs

aml_results <- df %>% 
  filter(!is_closed) %>% 
  mutate(var. = cbind(temp_c, humi_p, prcp_mm,
                      tueE, wedE, thuE, friE, satE, 
                      container, liquors, sales, halfs)) %>% 
  mutate(outputs = cbind(food_waste_kg, solid_waste_kg,liquid_waste_kg)) %>% 
  # mutate(outputs = cbind(food_loss_kg, food_waste_kg,
  #                        solid_waste_kg, liquid_waste_kg)) %>% 
  lm(outputs ~ var., data =.)
summary(aml_results)
```

## Coefficients Visualization
```{r visualize coeffs}
library(broom)
library(ggplot2)
source("get_stars.R")
model_outputs <- tidy(aml_results)
conf_ints <- aml_results %>% 
  tidy(., conf.int = TRUE) %>% 
  mutate(
    p.stars = get_stars(p.value, c(0.05, 0.01, 0.001)),
    p.label = sprintf("%.*f", digits=2, estimate),
    p.label = sprintf("%s %s", p.label, p.stars)
  ) %>% 
  filter(!term %in% "(Intercept)")
conf_ints$term <- factor(conf_ints$term, 
                         levels = c("var.temp_c", "var.humi_p", "var.prcp_mm", 
                                    "var.tueE", "var.wedE", 
                                    "var.thuE", "var.friE", "var.satE",
                                    "var.container", "var.liquors",
                                    "var.sales", "var.halfs"))

# Plot coeffs
conf_ints %>% 
  ggplot(aes(x = term,
             y = estimate,
             fill = response),
         position = position_dodge(width = 0.8)) +
  geom_errorbar(aes(ymin=conf.low, ymax=conf.high, color = response), 
                width = 0.2, linewidth  = 0.5,
                position = position_dodge(width = 0.8)) +
  geom_hline(yintercept = 0, color = "red", linewidth = 0.5) +
  geom_point(aes(color = response), position = position_dodge(width = 0.8)) +
  # geom_text(aes_string(label = "p.label"), position = position_dodge(0.4),
  #           vjust = 0.4 * -1.5, hjust = -.1,
  #           show.legend = FALSE, size = 2) +
  coord_flip() +
  theme(panel.grid.minor.y = element_line(color = 2,
                                          linewidth = 0.25,
                                          linetype = 1))
```


## Per Customer
```{r food waste per customer}
## Multi-output linear regression -----
## Target outcomes:
# 1. food_waste_p_kg
# 2. solid_waste_p_kg
# 3. liquid_waste_p_kg
## predictors: temp_c, humi_p, prcp_mm, 
#              tueE, wedE, thuE, friE, satE,
#              container, liquors, sales, halfs
aml_result_p <- df %>% 
  filter(!is_closed) %>% 
  mutate(var. = cbind(temp_c, humi_p, prcp_mm, 
                           tueE, wedE, thuE, friE, satE, 
                           container, liquors, sales, halfs)) %>% 
  mutate(outputs = cbind(food_waste_p_kg,
                         solid_waste_p_kg, liquid_waste_p_kg)) %>% 
  lm(outputs ~ var., data =.)
summary(aml_result_p)
```

## Coefficients Visualization
```{r visualize coeffs per person}
library(broom)
library(ggplot2)
model_outputs <- tidy(aml_result_p)
conf_ints_p <- aml_result_p %>% 
  tidy(., conf.int = TRUE) %>% 
  mutate(
    p.stars = get_stars(p.value, c(0.05, 0.01, 0.001)),
    p.label = sprintf("%s", p.stars)
    # p.label = sprintf("%.*f", digits=2, estimate),
    # p.label = sprintf("%s %s", p.label, p.stars)
  ) %>% 
  filter(!term %in% "(Intercept)")
conf_ints_p$term <- factor(conf_ints_p$term, 
                         levels = c("var.temp_c", "var.humi_p", "var.prcp_mm", 
                                    "var.tueE", "var.wedE", 
                                    "var.thuE", "var.friE", "var.satE",
                                    "var.container", "var.liquors",
                                    "var.sales", "var.halfs"))

# Plot coeffs
conf_ints_p %>% 
  ggplot(aes(x = term,
             y = estimate,
             fill = response),
         position = position_dodge(width = 0.8)) +
  geom_errorbar(aes(ymin=conf.low, ymax=conf.high, color = response), 
                width = 0.2, linewidth  = 0.5,
                position = position_dodge(width = 0.8)) +
  geom_hline(yintercept = 0, color = "red", linewidth = 0.5) +
  geom_point(aes(color = response), position = position_dodge(width = 0.8)) +
  geom_text(aes_string(label = "p.label"), position = position_dodge(0.4),
            vjust = 0.4 * -1.5, hjust = -.1,
            show.legend = FALSE, size = 2) +
  coord_flip()
```



## RDiT
## Day of the week plot

## Scatter plot
```{r plot daily RD in Time}
### Color Legend ----
# blue line is no interaction -> parallel effect
# red line is with interaction -> not parallel
# black dot line is overall effect

# Daily Plot on food waste -----------------------------------------------
daily_waste <- df %>% 
  filter(is_closed %in% FALSE) %>% 
  ggplot(., aes(x = as.Date(date), y = food_waste_kg)) +
  geom_point() +
  stat_smooth(aes(color = 'Overall'), method = "lm", formula = y ~ x,
              linetype = "dashed", se = FALSE) +
  geom_parallel_slopes(aes(group = container, color = 'No interaction'), 
                       se = FALSE) +
  stat_smooth(aes(group = container, color = 'interaction'),
              method = "lm", formula = y ~ x, se = FALSE) +
  scale_x_date(date_labels = "%b %d") +
  scale_color_manual(name="Model Type",
                     breaks = c('Overall','No interaction','interaction'),
                     values = c('Overall' ='black',
                                'No interaction'='blue',
                                'interaction'='red')) +
  theme(legend.position = "right") +
  xlab("Date") + ylab("Daily Food Waste (kg)") +
  ggtitle("Container Charge Effect Food Waste")
daily_waste

# Daily Plot on solid food waste -----------------------------------------
daily_solid_waste <- 
  df %>% filter(is_closed %in% FALSE) %>% 
  ggplot(data = ., aes(x = as.Date(date), y = solid_waste_kg)) +
  geom_point() +
  stat_smooth(aes(color = 'Overall'), method = "lm", formula = y ~ x,
              linetype = "dashed", se = FALSE) +
  geom_parallel_slopes(aes(group = container, color = 'No interaction'), 
                       se = FALSE) +
  stat_smooth(aes(group = container, color = 'interaction'), 
              method = "lm", formula = y ~ x, se = FALSE) +
  scale_x_date(date_labels = "%b %d") +
  scale_color_manual(name="Model Type",
                     breaks = c('Overall','No interaction','interaction'),
                     values = c('Overall' ='black',
                                'No interaction'='blue',
                                'interaction'='red')) +
  theme(legend.position = "right") +
  xlab("Date") + ylab("Daily Solid Food Waste (kg)") +
  ggtitle("Container Charge Effect on Solid Food Waste")
daily_solid_waste

# Daily Plot on liquid food waste ----------------------------------------
daily_liquid_waste <- 
  df %>% filter(is_closed %in% FALSE) %>% 
  ggplot(data = ., aes(x = as.Date(date), y = liquid_waste_kg)) +
  geom_point() +
  stat_smooth(aes(color = 'Overall'), method = "lm", 
              formula = y ~ x,  linetype = "dashed", se = FALSE) +
  geom_parallel_slopes(aes(group = container, color = 'No interaction'), 
                       se = FALSE) +
  stat_smooth(aes(group = container, color = 'interaction'),
              method = "lm", formula = y ~ x, se = FALSE) +
  scale_x_date(date_labels = "%b %d") +
  scale_color_manual(name="Model Type",
                     breaks = c('Overall','No interaction','interaction'),
                     values = c('Overall' ='black',
                                'No interaction'='blue',
                                'interaction'='red')) +
  theme(legend.position = "right") +
  xlab("Date") + ylab("Daily Liquid ood Waste (kg)") +
  ggtitle("Container Charge Effect on Liquid Food Waste")
daily_liquid_waste

# grid.arrange(daily_waste,
#              daily_solid_waste,daily_liquid_waste)
```
## Scatter plot per Customer
```{r plot per customer RD in Time}
library(moderndive)
# Daily Plot on food waste -----------------------------------------------
daily_waste_p <- 
  df %>% filter(is_closed %in% FALSE) %>% 
  ggplot(data = ., aes(x = as.Date(date), y = food_waste_p_kg)) +
  geom_point() +
  stat_smooth(aes(color = 'Overall'), method = "lm", formula = y ~ x,
              linetype = "dashed", se = FALSE) +
  geom_parallel_slopes(aes(group = container, color = 'No interaction'),
                       se = FALSE) +
  stat_smooth(aes(group = container, color = 'interaction'), 
              method = "lm", formula = y ~ x, se = FALSE) +
  stat_smooth(aes(group = container, color = 'Poly'), 
              method = "lm", formula = y ~ poly(x,2), se = FALSE) +
  scale_color_manual(name="Model Type",
                     breaks = c('Overall','No interaction','interaction','Poly'),
                     values = c('Overall' ='black',
                                'No interaction'='blue',
                                'interaction'='red',
                                'Poly' = 'dark green')) +
  theme(legend.position = "right") +
  scale_x_date(date_labels = "%b %d") +
  xlab("Date") + ylab("Food Waste per Customer (kg)") +
  ggtitle("Container Charge Effect on Food Waste per Customer")
daily_waste_p

# Daily Plot on solid food waste -----------------------------------------
daily_solid_waste_p <- 
  df %>% filter(is_closed %in% FALSE) %>% 
  ggplot(data = ., aes(x = as.Date(date), y = solid_waste_p_kg)) +
  geom_point() +
  stat_smooth(aes(color = 'Overall'), method = "lm", formula = y ~ x,
              linetype = "dashed", se = FALSE) +
  geom_parallel_slopes(aes(group = container, color = 'No interaction'), 
                       se = FALSE) +
  stat_smooth(aes(group = container, color = 'interaction'), method = "lm",
              formula = y ~ x, se = FALSE) +
  stat_smooth(aes(group = container, color = 'Poly'), 
              method = "lm", formula = y ~ poly(x,2), se = FALSE) +
  scale_color_manual(name="Model Type",
                     breaks = c('Overall','No interaction','interaction','Poly'),
                     values = c('Overall' ='black',
                                'No interaction'='blue',
                                'interaction'='red',
                                'Poly' = 'dark green')) +
  theme(legend.position = "right") +
  scale_x_date(date_labels = "%b %d") +
  xlab("Date") + ylab("Solid Food Waste per Customer (kg)") +
  ggtitle("Container Charge Effect on Solid Food Waste per Customer")
daily_solid_waste_p

# Daily Plot on liquid food waste ----------------------------------------
daily_liquid_waste_p <- 
  df %>% filter(is_closed %in% FALSE) %>% 
  ggplot(data = ., aes(x = as.Date(date), y = liquid_waste_p_kg)) +
  geom_point() +
  stat_smooth(aes(color = 'Overall'), method = "lm", formula = y ~ x,
              linetype = "dashed", se = FALSE) +
  geom_parallel_slopes(aes(group = container, color = 'No interaction'), 
                       se = FALSE) +
  stat_smooth(aes(group = container, color = 'interaction'), 
              method = "lm", formula = y ~ x, se = FALSE) +
  stat_smooth(aes(group = container, color = 'Poly'), 
              method = "lm", formula = y ~ poly(x,2), se = FALSE) +
  scale_color_manual(name="Model Type",
                     breaks = c('Overall','No interaction','interaction','Poly'),
                     values = c('Overall' ='black',
                                'No interaction'='blue',
                                'interaction'='red',
                                'Poly' = 'dark green')) +
  theme(legend.position = "right") +
  scale_x_date(date_labels = "%b %d") +
  xlab("Date") + ylab("Liquid Food Waste per Customer (kg)") +
  ggtitle("Container Charge Effect on Liquid Food Waste per Customer")
daily_liquid_waste_p

# grid.arrange(daily_loss_waste,daily_loss, daily_waste,
#              daily_solid_waste,daily_liquid_waste)
```

# RDinT Analysis
```{r rdint data create}
library(dplyr)
df <- df %>%
  filter(is_closed %in% FALSE) %>% 
  mutate(time = seq(1:sum(!df$is_closed)))

cutoff <- df %>% filter(date %in% as.Date('2023-01-03')) %>% dplyr::select(time) %>% as.numeric()

df <- df %>%  mutate(time = time - cutoff)
```

## Interaction
```{r rdint interaction}
# Multi-output model
## Target outcomes:
# 1. food_waste_p_kg
# 2. solid_waste_p_kg
# 3. liquid_waste_p_kg
## predictors: temp_c, humi_p, prcp_mm, 
#              tueE, wedE, thuE, friE, satE,
#              container, liquors, sales, halfs
rdts_int_fw <- df %>% 
  filter(!is_closed) %>% 
  mutate(var. = cbind(container, time, container*time)) %>% 
  mutate(outputs = cbind(food_waste_kg,
                         solid_waste_kg, liquid_waste_kg)) %>% 
  lm(outputs ~ var., data =.)
summary(rdts_int_fw)

# simple food waste -----
# Formula:
rdt_int_fw <- food_waste_kg ~ container * time 
rdt_int_fw <- df %>% 
            filter(!is_closed) %>% 
            lm(rdt_int_fw, data = .)
summary(rdt_int_fw)

#####
# summary(rdt_fw <- lm(formula =  rdt_fw, 
#                      data = df, subset = (!df$is_closed)))

# simple solid food waste -----
rdt_int_sfw <- solid_waste_kg ~ container * time 
rdt_int_sfw <- df %>% 
            filter(!is_closed) %>% 
            lm(rdt_int_sfw, data = .)
summary(rdt_int_sfw)

# simple liquid food waste -----
rdt_int_lfw <- liquid_waste_kg ~ container * time 
rdt_int_lfw <- df %>% 
            filter(!is_closed) %>% 
            lm(rdt_int_lfw, data = .)
summary(rdt_int_lfw)
```

## Ass-Interaction
1. Linearity of the relationships between the dependent and independent variables
2. Normality of the residuals
3. Homoscedasticity of the residuals
4. No influential points (outliers)
5. No multicollinearity
6. Independence of the observations
```{r assumption_interaction_fw RDiT}
library(performance)
ass_int_fw  <- plot(check_model(rdt_int_fw,  detrend=FALSE, panel = FALSE))
ass_int_sfw <- plot(check_model(rdt_int_sfw, detrend=FALSE, panel = FALSE))
ass_int_lfw <- plot(check_model(rdt_int_lfw, detrend=FALSE, panel = FALSE))

# 1. Linearity of the relationships between the dependent and independent variables
# 1.1 plot residual vs fitted values
ass_int_fw[[2]]  + labs(title = "Linearity: Food Waste", subtitle = "")
ass_int_sfw[[2]] + labs(title = "Linearity: Solid Food Waste", subtitle = "")
ass_int_lfw[[2]] + labs(title = "Linearity: Liquid Food Waste", subtitle = "")

# 1.2 check linearity
check_heteroscedasticity(rdt_int_fw)
check_heteroscedasticity(rdt_int_sfw)
check_heteroscedasticity(rdt_int_lfw)

# 2. Normality of the residuals
# 2.1 histogram of residuals
# Normality of Residuals: Food Waste
plot(check_normality(rdt_int_fw), type = "density") + 
  labs(title = "Normality of Residuals: Food Waste", subtitle = "")
# Normality of Residuals: Solid Food Waste
plot(check_normality(rdt_int_sfw), type = "density") + 
  labs(title = "Normality of Residuals: Solid Food Waste", subtitle = "") 
# Normality of Residuals: Liquid Food Waste
plot(check_normality(rdt_int_lfw), type = "density") + 
  labs(title = "Normality of Residuals: Liquid Food Waste", subtitle = "") 

# 2.2 Normality of Residuals
ass_int_fw[[6]]  + labs(title = "QQ Plot of Residuals: Food Waste", subtitle = "")
ass_int_sfw[[6]] + labs(title = "QQ Plot of Residuals: Solid Food Waste", subtitle = "")
ass_int_lfw[[6]] + labs(title = "QQ Plot of Residuals: Liquid Food Waste", subtitle = "")

# 2.3 shapiro-wilk normality test
check_normality(rdt_int_fw)
check_normality(rdt_int_sfw)
check_normality(rdt_int_lfw)

# 3. Homoscedasticity of the residuals
# 3.1 plot residuals
ass_int_fw[[3]]  + labs(title = "Homoscedasticity: Food Waste", subtitle = "")
ass_int_sfw[[3]] + labs(title = "Homoscedasticity: Solid Food Waste", subtitle = "")
ass_int_lfw[[3]] + labs(title = "Homoscedasticity: Liquid Food Waste", subtitle = "")

# 3.2 Breusch-Pagan test
lmtest::bptest(rdt_int_fw)
lmtest::bptest(rdt_int_sfw)
lmtest::bptest(rdt_int_lfw)

# 4. No influential points (outliers)
ass_int_fw[[4]]  + labs(title = "Outliers: Food Waste", subtitle = "")
ass_int_sfw[[4]] + labs(title = "Outliers: Solid Food Waste", subtitle = "")
ass_int_lfw[[4]] + labs(title = "Outliers: Liquid Food Waste", subtitle = "")

# 5. No multicollinearity
ass_int_fw[[5]]  + labs(title = "VIF: Food Waste", subtitle = "")
ass_int_sfw[[5]] + labs(title = "VIF: Solid Food Waste", subtitle = "")
ass_int_lfw[[5]] + labs(title = "VIF: Liquid Food Waste", subtitle = "")

# 6. Independence of the observations
# Autocorrelation
check_autocorrelation(rdt_int_fw)
check_autocorrelation(rdt_int_sfw)
check_autocorrelation(rdt_int_lfw)
```



## Multiple model
```{r rdint multiple model}
# multi food waste -----
rdt_multi_fw <- food_waste_kg ~ container * time +
                            temp_c + humi_p + prcp_mm + 
                            liquors + sales + halfs
rdt_multi_fw <- df %>% 
            filter(!is_closed) %>% 
            lm(rdt_multi_fw, data = .)
summary(rdt_multi_fw)

# multi solid food waste -----
rdt_multi_sfw <- solid_waste_kg ~ container * time +
                            temp_c + humi_p + prcp_mm + 
                            liquors + sales + halfs

rdt_multi_sfw <- df %>% 
            filter(!is_closed) %>% 
            lm(rdt_multi_sfw, data = .)
summary(rdt_multi_sfw)

# multi liquid food waste -----
rdt_multi_lfw <- liquid_waste_kg ~ container * time +
                            temp_c + humi_p + prcp_mm + 
                            liquors + sales + halfs
rdt_multi_lfw <- df %>% 
            filter(!is_closed) %>% 
            lm(rdt_multi_lfw, data = .)
summary(rdt_multi_lfw)
```

#### Ass-Multiple
1. Linearity of the relationships between the dependent and independent variables
2. Normality of the residuals
3. Homoscedasticity of the residuals
4. No influential points (outliers)
5. No multicollinearity
6. Independence of the observations
```{r assumption_multiple_fw RDiT}
library(performance)
ass_multi_fw  <- plot(check_model(rdt_multi_fw, detrend=FALSE,panel = FALSE))
ass_multi_sfw <- plot(check_model(rdt_multi_sfw, detrend=FALSE,panel = FALSE))
ass_multi_lfw <- plot(check_model(rdt_multi_lfw, detrend=FALSE,panel = FALSE))

# 1. Linearity of the relationships between the dependent and independent variables
# 1.1 plot residual vs fitted values
ass_multi_fw[[2]]  + labs(title = "Linearity: Food Waste", subtitle = "")
ass_multi_sfw[[2]] + labs(title = "Linearity: Solid Food Waste", subtitle = "")
ass_multi_lfw[[2]] + labs(title = "Linearity: Liquid Food Waste", subtitle = "")

# 1.2 check linearity
check_heteroscedasticity(rdt_multi_fw)
check_heteroscedasticity(rdt_multi_sfw)
check_heteroscedasticity(rdt_multi_lfw)

# 2. Normality of the residuals
# 2.1 histogram of residuals
# Normality of Residuals: Food Waste
plot(check_normality(rdt_multi_fw), type = "density") + 
  labs(title = "Normality of Residuals: Food Waste", subtitle = "")
# Normality of Residuals: Solid Food Waste
plot(check_normality(rdt_multi_sfw), type = "density") + 
  labs(title = "Normality of Residuals: Solid Food Waste", subtitle = "")
# Normality of Residuals: Liquid Food Waste
plot(check_normality(rdt_multi_lfw), type = "density") + 
  labs(title = "Normality of Residuals: Liquid Food Waste", subtitle = "")

# 2.2 Normality of Residuals
ass_multi_fw[[6]]  + 
  labs(title = "QQ Plot of Residuals: Food Waste", subtitle = "")
ass_multi_sfw[[6]] + 
  labs(title = "QQ Plot of Residuals: Solid Food Waste", subtitle = "")
ass_multi_lfw[[6]] + 
  labs(title = "QQ Plot of Residuals: Liquid Food Waste", subtitle = "")

# 2.3 shapiro-wilk normality test
check_normality(rdt_multi_fw)
check_normality(rdt_multi_sfw)
check_normality(rdt_multi_lfw)

# 3. Homoscedasticity of the residuals
# 3.1 plot residuals
ass_multi_fw[[3]]  + 
  labs(title = "Homoscedasticity: Food Waste", subtitle = "")
ass_multi_sfw[[3]] + 
  labs(title = "Homoscedasticity: Solid Food Waste", subtitle = "")
ass_multi_lfw[[3]] + 
  labs(title = "Homoscedasticity: Liquid Food Waste", subtitle = "")

# 3.2 Breusch-Pagan test
lmtest::bptest(rdt_multi_fw)
lmtest::bptest(rdt_multi_sfw)
lmtest::bptest(rdt_multi_lfw)

# 4. No influential points (outliers)
ass_multi_fw[[4]]  + labs(title = "Outliers: Food Waste", subtitle = "")
ass_multi_sfw[[4]] + labs(title = "Outliers: Solid Food Waste", subtitle = "")
ass_multi_lfw[[4]] + labs(title = "Outliers: Liquid Food Waste", subtitle = "")

# 5. No multicollinearity
ass_multi_fw[[5]]  + labs(title = "VIF: Food Waste", subtitle = "")
ass_multi_sfw[[5]] + labs(title = "VIF: Solid Food Waste", subtitle = "")
ass_multi_lfw[[5]] + labs(title = "VIF: Liquid Food Waste", subtitle = "")

# 6. Independence of the observations
# Autocorrelation
check_autocorrelation(rdt_multi_fw)
check_autocorrelation(rdt_multi_sfw)
check_autocorrelation(rdt_multi_lfw)
```


## Polynomial model
```{r rdint polynomial model}
# poly- food waste -----
rdt_poly_fw <- food_waste_kg ~ container * time + 
                             container * I(time^2) +
                             temp_c + humi_p + prcp_mm + 
                             liquors + sales + halfs
rdt_poly_fw <- df %>% 
            filter(!is_closed) %>% 
            lm(rdt_poly_fw, data = .)
summary(rdt_poly_fw)

# poly- solid food waste -----
rdt_poly_sfw <- solid_waste_kg ~ container * time + 
                               container * I(time^2) +
                               temp_c + humi_p + prcp_mm + 
                               liquors + sales + halfs
rdt_poly_sfw <- df %>% 
            filter(!is_closed) %>% 
            lm(rdt_poly_sfw, data = .)
summary(rdt_poly_sfw)

# poly- liquid food waste -----
rdt_poly_lfw <- liquid_waste_kg ~ container * time + 
                                container * I(time^2) +
                                temp_c + humi_p + prcp_mm + 
                                liquors + sales + halfs
rdt_poly_lfw <- df %>% 
            filter(!is_closed) %>% 
            lm(rdt_poly_lfw, data = .)
summary(rdt_poly_lfw)
```

## Ass-Poly
1. Linearity of the relationships between the dependent and independent variables
2. Normality of the residuals
3. Homoscedasticity of the residuals
4. No influential points (outliers)
5. No multicollinearity
6. Independence of the observations
```{r assumption_polynomial_fw RDiT}
library(performance)
ass_poly_fw  <- plot(check_model(rdt_poly_fw, detrend=FALSE,panel = FALSE))
ass_poly_sfw <- plot(check_model(rdt_poly_sfw, detrend=FALSE,panel = FALSE))
ass_poly_lfw <- plot(check_model(rdt_poly_lfw, detrend=FALSE,panel = FALSE))

# 1. Linearity of the relationships between the dependent and independent variables
# 1.1 plot residual vs fitted values
ass_poly_fw[[2]]  + labs(title = "Linearity: Food Waste", subtitle = "")
ass_poly_sfw[[2]] + labs(title = "Linearity: Solid Food Waste", subtitle = "")
ass_poly_lfw[[2]] + labs(title = "Linearity: Liquid Food Waste", subtitle = "")

# 1.2 check linearity
check_heteroscedasticity(rdt_poly_fw)
check_heteroscedasticity(rdt_poly_sfw)
check_heteroscedasticity(rdt_poly_lfw)

# 2. Normality of the residuals
# 2.1 histogram of residuals
# Normality of Residuals: Food Waste
plot(check_normality(rdt_poly_fw), type = "density") + 
  labs(title = "Normality of Residuals: Food Waste", subtitle = "")
# Normality of Residuals: Solid Food Waste
plot(check_normality(rdt_poly_sfw), type = "density") + 
  labs(title = "Normality of Residuals: Solid Food Waste", subtitle = "")
# Normality of Residuals: Liquid Food Waste
plot(check_normality(rdt_poly_lfw), type = "density") + 
  labs(title = "Normality of Residuals: Liquid Food Waste", subtitle = "")

# 2.2 Normality of Residuals
ass_poly_fw[[6]]  + 
  labs(title = "QQ Plot of Residuals: Food Waste", subtitle = "")
ass_poly_sfw[[6]] + 
  labs(title = "QQ Plot of Residuals: Solid Food Waste", subtitle = "")
ass_poly_lfw[[6]] + 
  labs(title = "QQ Plot of Residuals: Liquid Food Waste", subtitle = "")

# 2.3 shapiro-wilk normality test
check_normality(rdt_poly_fw)
check_normality(rdt_poly_sfw)
check_normality(rdt_poly_lfw)

# 3. Homoscedasticity of the residuals
# 3.1 plot residuals
ass_poly_fw[[3]]  + 
  labs(title = "Homoscedasticity: Food Waste", subtitle = "")
ass_poly_sfw[[3]] + 
  labs(title = "Homoscedasticity: Solid Food Waste", subtitle = "")
ass_poly_lfw[[3]] + 
  labs(title = "Homoscedasticity: Liquid Food Waste", subtitle = "")

# 3.2 Breusch-Pagan test
lmtest::bptest(rdt_poly_fw)
lmtest::bptest(rdt_poly_sfw)
lmtest::bptest(rdt_poly_lfw)

# 4. No influential points (outliers)
ass_poly_fw[[4]]  + labs(title = "Outliers: Food Waste", subtitle = "")
ass_poly_sfw[[4]] + labs(title = "Outliers: Solid Food Waste", subtitle = "")
ass_poly_lfw[[4]] + labs(title = "Outliers: Liquid Food Waste", subtitle = "")

# 5. No multicollinearity
ass_poly_fw[[5]]  + labs(title = "VIF: Food Waste", subtitle = "")
ass_poly_sfw[[5]] + labs(title = "VIF: Solid Food Waste", subtitle = "")
ass_poly_lfw[[5]] + labs(title = "VIF: Liquid Food Waste", subtitle = "")

# 6. Independence of the observations
# Autocorrelation
check_autocorrelation(rdt_poly_fw)
check_autocorrelation(rdt_poly_sfw)
check_autocorrelation(rdt_poly_lfw)
```

\newpage
# Per Customer
## Interaction
```{r rdint per customer model interaction}
################ Interaction

# simple food waste per customer -----
rdt_int_fw_p <- food_waste_p_kg ~ container * time 

rdt_int_fw_p <- df %>% 
            filter(!is_closed) %>% 
            lm(rdt_int_fw_p, data = .)
summary(rdt_int_fw_p)

# simple solid food waste per customer -----
rdt_int_sfw_p <- solid_waste_p_kg ~ container * time 
rdt_int_sfw_p <- df %>% 
            filter(!is_closed) %>% 
            lm(rdt_int_sfw_p, data = .)
summary(rdt_int_sfw_p)

# simple liquid food waste per customer -----
rdt_int_lfw_p <- liquid_waste_p_kg ~ container * time 
rdt_int_lfw_p <- df %>% 
            filter(!is_closed) %>% 
            lm(rdt_int_lfw_p, data = .)
summary(rdt_int_lfw_p)
```

## Ass-Interaction
1. Linearity of the relationships between the dependent and independent variables
2. Normality of the residuals
3. Homoscedasticity of the residuals
4. No influential points (outliers)
5. No multicollinearity
6. Independence of the observations
```{r assumption_interaction_fw_person RDiT}
library(performance)
ass_int_fw_p  <- plot(check_model(rdt_int_fw_p, detrend=FALSE, panel = FALSE))
ass_int_sfw_p <- plot(check_model(rdt_int_sfw_p, detrend=FALSE,panel = FALSE))
ass_int_lfw_p <- plot(check_model(rdt_int_lfw_p, detrend=FALSE,panel = FALSE))

# 1. Linearity of the relationships between the dependent and independent variables
# 1.1 plot residual vs fitted values
ass_int_fw_p[[2]]  + labs(title = "Linearity: Food Waste", subtitle = "")
ass_int_sfw_p[[2]] + labs(title = "Linearity: Solid Food Waste", subtitle = "")
ass_int_lfw_p[[2]] + labs(title = "Linearity: Liquid Food Waste", subtitle = "")

# 1.2 check linearity
check_heteroscedasticity(rdt_int_fw_p)
check_heteroscedasticity(rdt_int_sfw_p)
check_heteroscedasticity(rdt_int_lfw_p)

# 2. Normality of the residuals
# 2.1 histogram of residuals
# Normality of Residuals: Food Waste
plot(check_normality(rdt_int_fw_p), type = "density") + 
  labs(title = "Normality of Residuals: Food Waste", subtitle = "")
# Normality of Residuals: Solid Food Waste
plot(check_normality(rdt_int_sfw_p), type = "density") + 
  labs(title = "Normality of Residuals: Solid Food Waste", subtitle = "") 
# Normality of Residuals: Liquid Food Waste
plot(check_normality(rdt_int_lfw_p), type = "density") + 
  labs(title = "Normality of Residuals: Liquid Food Waste", subtitle = "") 

# 2.2 Normality of Residuals
ass_int_fw_p[[6]]  + labs(title = "QQ Plot of Residuals: Food Waste", subtitle = "")
ass_int_sfw_p[[6]] + labs(title = "QQ Plot of Residuals: Solid Food Waste", subtitle = "")
ass_int_lfw_p[[6]] + labs(title = "QQ Plot of Residuals: Liquid Food Waste", subtitle = "")

# 2.3 shapiro-wilk normality test
check_normality(rdt_int_fw_p)
check_normality(rdt_int_sfw_p)
check_normality(rdt_int_lfw_p)

# 3. Homoscedasticity of the residuals
# 3.1 plot residuals
ass_int_fw_p[[3]]  + labs(title = "Homoscedasticity: Food Waste", subtitle = "")
ass_int_sfw_p[[3]] + labs(title = "Homoscedasticity: Solid Food Waste", subtitle = "")
ass_int_lfw_p[[3]] + labs(title = "Homoscedasticity: Liquid Food Waste", subtitle = "")

# 3.2 Breusch-Pagan test
lmtest::bptest(rdt_int_fw_p)
lmtest::bptest(rdt_int_sfw_p)
lmtest::bptest(rdt_int_lfw_p)

# 4. No influential points (outliers)
ass_int_fw_p[[4]]  + labs(title = "Outliers: Food Waste", subtitle = "")
ass_int_sfw_p[[4]] + labs(title = "Outliers: Solid Food Waste", subtitle = "")
ass_int_lfw_p[[4]] + labs(title = "Outliers: Liquid Food Waste", subtitle = "")

# 5. No multicollinearity
ass_int_fw_p[[5]]  + labs(title = "VIF: Food Waste", subtitle = "")
ass_int_sfw_p[[5]] + labs(title = "VIF: Solid Food Waste", subtitle = "")
ass_int_lfw_p[[5]] + labs(title = "VIF: Liquid Food Waste", subtitle = "")

# 6. Independence of the observations
# Autocorrelation
check_autocorrelation(rdt_int_fw_p)
check_autocorrelation(rdt_int_sfw_p)
check_autocorrelation(rdt_int_lfw_p)
```

## Multiple model
```{r rdint per customer model multiple}
## Multiple model ----
# multi food waste per customer -----
rdt_multi_fw_p <- food_waste_p_kg ~ container * time +
                            temp_c + humi_p + prcp_mm + 
                            liquors + sales + halfs
rdt_multi_fw_p <- df %>% 
            filter(!is_closed) %>% 
            lm(rdt_multi_fw_p, data = .)
summary(rdt_multi_fw_p)

# multi solid food waste per customer -----
rdt_multi_sfw_p <- solid_waste_p_kg ~ container * time +
                            temp_c + humi_p + prcp_mm + 
                            liquors + sales + halfs
rdt_multi_sfw_p <- df %>% 
            filter(!is_closed) %>% 
            lm(rdt_multi_sfw_p, data = .)
summary(rdt_multi_sfw_p)

# multi liquid food waste per customer -----
rdt_multi_lfw_p <- liquid_waste_p_kg ~ container * time +
                            temp_c + humi_p + prcp_mm + 
                            liquors + sales + halfs
rdt_multi_lfw_p <- df %>% 
            filter(!is_closed) %>% 
            lm(rdt_multi_lfw_p, data = .)
summary(rdt_multi_lfw_p)
```

## Ass-Multiple
1. Linearity of the relationships between the dependent and independent variables
2. Normality of the residuals
3. Homoscedasticity of the residuals
4. No influential points (outliers)
5. No multicollinearity
6. Independence of the observations
```{r assumption_multiple_fw_person RDiT}
library(performance)
ass_multi_fw_p  <- plot(check_model(rdt_multi_fw_p,  detrend=FALSE,panel = FALSE))
ass_multi_sfw_p <- plot(check_model(rdt_multi_sfw_p, detrend=FALSE,panel = FALSE))
ass_multi_lfw_p <- plot(check_model(rdt_multi_lfw_p, detrend=FALSE,panel = FALSE))

# 1. Linearity of the relationships between the dependent and independent variables
# 1.1 plot residual vs fitted values
ass_multi_fw_p[[2]]  + labs(title = "Linearity: Food Waste", subtitle = "")
ass_multi_sfw_p[[2]] + labs(title = "Linearity: Solid Food Waste", subtitle = "")
ass_multi_lfw_p[[2]] + labs(title = "Linearity: Liquid Food Waste", subtitle = "")

# 1.2 check linearity
check_heteroscedasticity(rdt_multi_fw_p)
check_heteroscedasticity(rdt_multi_sfw_p)
check_heteroscedasticity(rdt_multi_lfw_p)

# 2. Normality of the residuals
# 2.1 histogram of residuals
# Normality of Residuals: Food Waste
plot(check_normality(rdt_multi_fw_p), type = "density") + 
  labs(title = "Normality of Residuals: Food Waste", subtitle = "")
# Normality of Residuals: Solid Food Waste
plot(check_normality(rdt_multi_sfw_p), type = "density") + 
  labs(title = "Normality of Residuals: Solid Food Waste", subtitle = "")
# Normality of Residuals: Liquid Food Waste
plot(check_normality(rdt_multi_lfw_p), type = "density") + 
  labs(title = "Normality of Residuals: Liquid Food Waste", subtitle = "")

# 2.2 Normality of Residuals
ass_multi_fw_p[[6]]  + 
  labs(title = "QQ Plot of Residuals: Food Waste", subtitle = "")
ass_multi_sfw_p[[6]] + 
  labs(title = "QQ Plot of Residuals: Solid Food Waste", subtitle = "")
ass_multi_lfw_p[[6]] + 
  labs(title = "QQ Plot of Residuals: Liquid Food Waste", subtitle = "")

# 2.3 shapiro-wilk normality test
check_normality(rdt_multi_fw)
check_normality(rdt_multi_sfw)
check_normality(rdt_multi_lfw)

# 3. Homoscedasticity of the residuals
# 3.1 plot residuals
ass_multi_fw_p[[3]]  + 
  labs(title = "Homoscedasticity: Food Waste", subtitle = "")
ass_multi_sfw_p[[3]] + 
  labs(title = "Homoscedasticity: Solid Food Waste", subtitle = "")
ass_multi_lfw_p[[3]] + 
  labs(title = "Homoscedasticity: Liquid Food Waste", subtitle = "")

# 3.2 Breusch-Pagan test
lmtest::bptest(rdt_multi_fw_p)
lmtest::bptest(rdt_multi_sfw_p)
lmtest::bptest(rdt_multi_lfw_p)

# 4. No influential points (outliers)
ass_multi_fw_p[[4]]  + labs(title = "Outliers: Food Waste", subtitle = "")
ass_multi_sfw_p[[4]] + labs(title = "Outliers: Solid Food Waste", subtitle = "")
ass_multi_lfw_p[[4]] + labs(title = "Outliers: Liquid Food Waste", subtitle = "")

# 5. No multicollinearity
ass_multi_fw_p[[5]]  + labs(title = "VIF: Food Waste", subtitle = "")
ass_multi_sfw_p[[5]] + labs(title = "VIF: Solid Food Waste", subtitle = "")
ass_multi_lfw_p[[5]] + labs(title = "VIF: Liquid Food Waste", subtitle = "")

# 6. Independence of the observations
# Autocorrelation
check_autocorrelation(rdt_multi_fw_p)
check_autocorrelation(rdt_multi_sfw_p)
check_autocorrelation(rdt_multi_lfw_p)
```

## polynomial model
```{r rdint per customer quadatic model}
# poly- food waste per customer -----
rdt_poly_fw_p <- food_waste_p_kg ~ container * time + 
                             container * I(time^2) + 
                             temp_c + humi_p + prcp_mm + 
                             liquors + sales + halfs
rdt_poly_fw_p <- df %>% 
            filter(!is_closed) %>% 
            lm(rdt_poly_fw_p, data = .)
summary(rdt_poly_fw_p)

# poly- solid food waste per customer -----
rdt_poly_sfw_p <- solid_waste_p_kg ~ container * time + 
                               container * I(time^2) +
                               temp_c + humi_p + prcp_mm + 
                               liquors + sales + halfs
rdt_poly_sfw_p <- df %>% 
            filter(!is_closed) %>% 
            lm(rdt_poly_sfw_p, data = .)
summary(rdt_poly_sfw_p)

# poly- liquid food waste per customer -----
rdt_poly_lfw_p <- liquid_waste_p_kg ~ container * time + 
                                container * I(time^2) +
                                temp_c + humi_p + prcp_mm + 
                                liquors + sales + halfs
rdt_poly_lfw_p <- df %>% 
            filter(!is_closed) %>% 
            lm(rdt_poly_lfw_p, data = .)
summary(rdt_poly_lfw_p)
```

## Ass-Poly
1. Linearity of the relationships between the dependent and independent variables
2. Normality of the residuals
3. Homoscedasticity of the residuals
4. No influential points (outliers)
5. No multicollinearity
6. Independence of the observations
```{r assumption_polynomial_fw_p RDiT}
library(performance)
ass_poly_fw_p  <- plot(check_model(rdt_poly_fw_p, detrend=FALSE,panel = FALSE))
ass_poly_sfw_p <- plot(check_model(rdt_poly_sfw_p, detrend=FALSE,panel = FALSE))
ass_poly_lfw_p <- plot(check_model(rdt_poly_lfw_p, detrend=FALSE,panel = FALSE))

# 1. Linearity of the relationships between the dependent and independent variables
# 1.1 plot residual vs fitted values
ass_poly_fw_p[[2]]  + labs(title = "Linearity: Food Waste", subtitle = "")
ass_poly_sfw_p[[2]] + labs(title = "Linearity: Solid Food Waste", subtitle = "")
ass_poly_lfw_p[[2]] + labs(title = "Linearity: Liquid Food Waste", subtitle = "")

# 1.2 check linearity
check_heteroscedasticity(rdt_poly_fw_p)
check_heteroscedasticity(rdt_poly_sfw_p)
check_heteroscedasticity(rdt_poly_lfw_p)

# 2. Normality of the residuals
# 2.1 histogram of residuals
# Normality of Residuals: Food Waste
plot(check_normality(rdt_poly_fw_p), type = "density") + 
  labs(title = "Normality of Residuals: Food Waste", subtitle = "")
# Normality of Residuals: Solid Food Waste
plot(check_normality(rdt_poly_sfw_p), type = "density") + 
  labs(title = "Normality of Residuals: Solid Food Waste", subtitle = "")
# Normality of Residuals: Liquid Food Waste
plot(check_normality(rdt_poly_lfw_p), type = "density") + 
  labs(title = "Normality of Residuals: Liquid Food Waste", subtitle = "")

# 2.2 Normality of Residuals
ass_poly_fw_p[[6]]  + 
  labs(title = "QQ Plot of Residuals: Food Waste", subtitle = "")
ass_poly_sfw_p[[6]] + 
  labs(title = "QQ Plot of Residuals: Solid Food Waste", subtitle = "")
ass_poly_lfw_p[[6]] + 
  labs(title = "QQ Plot of Residuals: Liquid Food Waste", subtitle = "")

# 2.3 shapiro-wilk normality test
check_normality(rdt_poly_fw_p)
check_normality(rdt_poly_sfw_p)
check_normality(rdt_poly_lfw_p)

# 3. Homoscedasticity of the residuals
# 3.1 plot residuals
ass_poly_fw_p[[3]]  + 
  labs(title = "Homoscedasticity: Food Waste", subtitle = "")
ass_poly_sfw_p[[3]] + 
  labs(title = "Homoscedasticity: Solid Food Waste", subtitle = "")
ass_poly_lfw_p[[3]] + 
  labs(title = "Homoscedasticity: Liquid Food Waste", subtitle = "")

# 3.2 Breusch-Pagan test
lmtest::bptest(rdt_poly_fw_p)
lmtest::bptest(rdt_poly_sfw_p)
lmtest::bptest(rdt_poly_lfw_p)

# 4. No influential points (outliers)
ass_poly_fw_p[[4]]  + labs(title = "Outliers: Food Waste", subtitle = "")
ass_poly_sfw_p[[4]] + labs(title = "Outliers: Solid Food Waste", subtitle = "")
ass_poly_lfw_p[[4]] + labs(title = "Outliers: Liquid Food Waste", subtitle = "")

# 5. No multicollinearity
ass_poly_fw_p[[5]]  + labs(title = "VIF: Food Waste", subtitle = "")
ass_poly_sfw_p[[5]] + labs(title = "VIF: Solid Food Waste", subtitle = "")
ass_poly_lfw_p[[5]] + labs(title = "VIF: Liquid Food Waste", subtitle = "")

# 6. Independence of the observations
# Autocorrelation
check_autocorrelation(rdt_poly_fw_p)
check_autocorrelation(rdt_poly_sfw_p)
check_autocorrelation(rdt_poly_lfw_p)
```

## Cubic model
```{r rdint per customer cubic model}
# poly- food waste per customer -----
rdt_poly3_fw_p <- food_waste_p_kg ~ container * time + 
                             container * I(time^2) + container * I(time^3) + 
                             temp_c + humi_p + prcp_mm + 
                             liquors + sales + halfs
rdt_poly3_fw_p <- df %>% 
            filter(!is_closed) %>% 
            lm(rdt_poly3_fw_p, data = .)
summary(rdt_poly3_fw_p)

# poly- solid food waste per customer -----
rdt_poly3_sfw_p <- solid_waste_p_kg ~ container * time + 
                               container * I(time^2) + container * I(time^3) + 
                               temp_c + humi_p + prcp_mm + 
                               liquors + sales + halfs
rdt_poly3_sfw_p <- df %>% 
            filter(!is_closed) %>% 
            lm(rdt_poly3_sfw_p, data = .)
summary(rdt_poly3_sfw_p)

# poly- liquid food waste per customer -----
rdt_poly3_lfw_p <- liquid_waste_p_kg ~ container * time + 
                                container * I(time^2) + container * I(time^3) + 
                                temp_c + humi_p + prcp_mm + 
                                liquors + sales + halfs
rdt_poly3_lfw_p <- df %>% 
            filter(!is_closed) %>% 
            lm(rdt_poly3_lfw_p, data = .)
summary(rdt_poly3_lfw_p)
```

## Quartic model
```{r rdint per customer quartic model}
# poly- food waste per customer -----
rdt_poly4_fw_p <- food_waste_p_kg ~ container * time + 
                             container * I(time^2) + container * I(time^3) +  container * I(time^4) +
                             temp_c + humi_p + prcp_mm + 
                             liquors + sales + halfs
rdt_poly4_fw_p <- df %>% 
            filter(!is_closed) %>% 
            lm(rdt_poly4_fw_p, data = .)
summary(rdt_poly4_fw_p)

# poly- solid food waste per customer -----
rdt_poly4_sfw_p <- solid_waste_p_kg ~ container * time + 
                               container * I(time^2) + container * I(time^3) + container * I(time^4) +
                               temp_c + humi_p + prcp_mm + 
                               liquors + sales + halfs
rdt_poly4_sfw_p <- df %>% 
            filter(!is_closed) %>% 
            lm(rdt_poly4_sfw_p, data = .)
summary(rdt_poly4_sfw_p)

# poly- liquid food waste per customer -----
rdt_poly4_lfw_p <- liquid_waste_p_kg ~ container * time + 
                                container * I(time^2) + container * I(time^3) + container * I(time^4) +
                                temp_c + humi_p + prcp_mm + 
                                liquors + sales + halfs
rdt_poly4_lfw_p <- df %>% 
            filter(!is_closed) %>% 
            lm(rdt_poly4_lfw_p, data = .)
summary(rdt_poly4_lfw_p)
```
\newpage
## Some model
```{r sales model}
# sales base model
rdt_sales <- sales ~ container * time
rdt_sales <- df %>% 
            filter(!is_closed) %>% 
            lm(rdt_sales, data = .)
summary(rdt_sales)

# multiple -----
rdt_sales_mult <- sales ~ container * time +
                              temp_c + humi_p + prcp_mm + 
                               liquors + halfs
rdt_sales_mult <- df %>% 
            filter(!is_closed) %>% 
            lm(rdt_sales_mult, data = .)
summary(rdt_sales_mult)

# poly- liquid food waste per customer -----
rdt_sales <- sales ~ container * time +  container * I(time^2) + 
                      temp_c + humi_p + prcp_mm + 
                      liquors + halfs
rdt_sales <- df %>% 
            filter(!is_closed) %>% 
            lm(rdt_sales, data = .)
summary(rdt_sales)
```
\newpage
# Local Regression
## per Customer
```{r local regression in time window}
bandwidth = 25
# Local Regression of container on food_waste_kg ----
loc_fw_p <- df %>%
  filter(!is_closed) %>% 
  filter(abs(time) <= bandwidth) %>% 
  lm(food_waste_p_kg ~ container, data = .)
summary(loc_fw_p)

# Local Regression of container on solid food_waste_kg ----
loc_sfw_p <- df %>%
  filter(!is_closed) %>% 
  filter(abs(time) <= bandwidth) %>% 
  lm(solid_waste_p_kg ~ container, data = .)
summary(loc_sfw_p)

# Local Regression of container on liquid food_waste_kg----
loc_lfw_p <- df %>%
  filter(!is_closed) %>% 
  filter(abs(time) <= bandwidth) %>% 
  lm(liquid_waste_p_kg ~ container, data = .)
summary(loc_lfw_p)
```

## Interaction
```{r local regression interaction in time window}
bandwidth = 25

# Local Regression of container on food_waste_kg ----
loc_fw_p <- df %>%
  filter(!is_closed) %>% 
  filter(abs(time) <= bandwidth) %>% 
  lm(food_waste_p_kg ~ container*time, data = .)
summary(loc_fw_p)

# Local Regression of container on solid food_waste_kg ----
loc_sfw_p <- df %>%
  filter(!is_closed) %>% 
  filter(abs(time) <= bandwidth) %>% 
  lm(solid_waste_p_kg ~ container*time, data = .)
summary(loc_sfw_p)

# Local Regression of container on liquid food_waste_kg----
loc_lfw_p <- df %>%
  filter(!is_closed) %>% 
  filter(abs(time) <= bandwidth) %>% 
  lm(liquid_waste_p_kg ~ container*time, data = .)
summary(loc_lfw_p)

# Visualization local regression ----
locals <- tibble(bandwidth = seq(from = 6, to = 30, by = 1))
results_local <- locals %>% 
  group_by(bandwidth) %>% 
  mutate(
    loc_reg_p = map(bandwidth, ~ lm(food_waste_p_kg ~ container * time,
                                 data = subset(df, is_closed == FALSE), 
                                 subset = (abs(time) <= bandwidth))),
    tidied = map(loc_reg_p,tidy,conf.int = TRUE)
  ) %>% 
  unnest(tidied) %>% 
  filter(term == "container")

results_local %>% 
  ggplot(aes(x = bandwidth, y = estimate,
             ymin = conf.low, ymax = conf.high)) +
  geom_point() +
  geom_pointrange() +
  geom_hline(yintercept = 0, linetype = "dashed") +
  xlab("Band Width") + ylab("Estimated Effect") +
  ggtitle("Estimated Container Charge Effect on Food Waste with Interaction")
```

## Multiple 
```{r local regression multiple with time window}
bandwidth = 25

# Local Regression of container on food_waste_kg ----
loc_fw_p <- df %>%
  filter(!is_closed) %>% 
  filter(abs(time) <= bandwidth) %>% 
  lm(food_waste_p_kg ~ container*time
     + temp_c + humi_p + prcp_mm + liquors + sales + halfs, 
     data = .)
summary(loc_fw_p)

# Local Regression of container on solid food_waste_kg ----
loc_sfw_p <- df %>%
  filter(!is_closed) %>% 
  filter(abs(time) <= bandwidth) %>% 
  lm(solid_waste_p_kg ~ container*time
     + temp_c + humi_p + prcp_mm + liquors + sales + halfs,
     data = .)
summary(loc_sfw_p)

# Local Regression of container on liquid food_waste_kg----
loc_lfw_p <- df %>%
  filter(!is_closed) %>% 
  filter(abs(time) <= bandwidth) %>% 
  lm(liquid_waste_p_kg ~ container*time
     + temp_c + humi_p + prcp_mm + liquors + sales + halfs,
     data = .)
summary(loc_lfw_p)

# Visualization ----
# Local regression with multiple
results_local_multi <- locals %>% 
  group_by(bandwidth) %>% 
  mutate(
    loc_reg_p = map(bandwidth, ~ lm(food_waste_p_kg ~ container * time 
                                    + temp_c + humi_p + prcp_mm 
                                    + liquors + sales + halfs,
                                 data = subset(df, is_closed == FALSE), 
                                 subset = (abs(time) <= bandwidth))),
    tidied = map(loc_reg_p,tidy,conf.int = TRUE)
  ) %>% 
  unnest(tidied) %>% 
  filter(term == "container")

results_local_multi %>% 
  ggplot(aes(x = bandwidth, y = estimate,
             ymin = conf.low, ymax = conf.high)) +
  geom_point() +
  geom_pointrange() +
  geom_hline(yintercept = 0, linetype = "dashed") +
  xlab("Band Width") + ylab("Estimated Effect") +
  ggtitle("Estimated Container Charge Effect on Food Waste with Multiple Model")

# Donut regression with multiple
results_local_multi_donut <- locals %>% 
  group_by(bandwidth) %>% 
  mutate(
    loc_reg_p = map(bandwidth, ~ lm(food_waste_p_kg ~ container * time 
                                    + temp_c + humi_p + prcp_mm 
                                    + liquors + sales + halfs,
                                 data = subset(df, is_closed == FALSE), 
                                 subset = (abs(time) > bandwidth))),
    tidied = map(loc_reg_p,tidy,conf.int = TRUE)
  ) %>% 
  unnest(tidied) %>% 
  filter(term == "container")

results_local_multi_donut %>% 
  ggplot(aes(x = bandwidth, y = estimate,
             ymin = conf.low, ymax = conf.high)) +
  geom_point() +
  geom_pointrange() +
  geom_hline(yintercept = 0, linetype = "dashed") +
  xlab("Band Width") + ylab("Estimated Effect") +
  ggtitle("Estimated Container Charge Donut Effect on Food Waste with Multiple Model")
```



